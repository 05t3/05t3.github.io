---
title: "MSHTML & OOXML (.docx) Analysis"
date: 2025-06-09 01:09:33 +0300
author: [oste]
description: Uncover how attackers exploit .docx files using MSHTML components like mhtml. Learn to analyze .docx structures exposing malicious metadata and payloads.
image: /assets/img/Posts/mshtml.png
categories: [Lets Defend, Security Analyst, Hard]
tags:
  [MSHTML, OOXML, .docx, threat intelligence, malware analysis, EXIF data, CVE-2021-40444, mhtml exploit, document security, phishing, ransomware, zipdump.py, exiftool, YARA rules, sandbox analysis, metadata analysis, cybersecurity, document exploits, Microsoft Word, attack vectors]
---


2021's 0-Day MSHTML

This challenge prepared by [@Bohan Zhang](https://www.linkedin.com/in/bohan-zhang-078751137/) Malware samples: [MalwareBazaar](https://bazaar.abuse.ch/)

```bash
➜   md5sum *
45e7d6562bfddb816d45649dd667abde  Employee_W2_Form.docx
d5742309ba8146be9eab4396fde77e4e  Employees_Contact_Audit_Oct_2021.docx
41dacae2a33ee717abcc8011b705f2cb  Work_From_Home_Survey.doc
55998cb43459159a5ed4511f00ff3fc8  income_tax_and_benefit_return_2021.docx
➜   sha256sum *
679bbe0c50754853978a3a583505ebb99bce720cf26a6aaf8be06cd879701ff1  Employee_W2_Form.docx
ed2b9e22aef3e545814519151528b2d11a5e73d1b2119c067e672b653ab6855a  Employees_Contact_Audit_Oct_2021.docx
84674acffba5101c8ac518019a9afe2a78a675ef3525a44dceddeed8a0092c69  Work_From_Home_Survey.doc
d0e1f97dbe2d0af9342e64d460527b088d85f96d38b1d1d4aa610c0987dca745  income_tax_and_benefit_return_2021.docx
➜   sha1sum *
00087e46ec0ef6225de59868fd016bd9dd77fa3c  Employee_W2_Form.docx
8aaa79ee4a81d02e1023a03aee62a47162a9ff04  Employees_Contact_Audit_Oct_2021.docx
4b35d14a2eab2b3a7e0b40b71955cdd36e06b4b9  Work_From_Home_Survey.doc
9bec2182cc5b41fe8783bb7ab6e577bac5c19f04  income_tax_and_benefit_return_2021.docx
root@ip-172-31-6-252:~/Desktop/ChallengeFiles# 
```
{: .nolineno }

-----

## Questions

Examing the Employees_Contact_Audit_Oct_2021.docx file, what is the malicious IP in the docx file?

`175.24.190.249`

Examing the Employee_W2_Form.docx file, what is the malicious domain in the docx file?

`arsenal.30cm.tw`

Examing the Work_From_Home_Survey.doc file, what is the malicious domain in the doc file?

`trendparlye.com`

Examing the income_tax_and_benefit_return_2021.docx, what is the malicious domain in the docx file?

`hidusi.com`

What is the vulnerability the above files exploited?

`cve-2021-40444`

-----

## Docx

A `.DOCX` file is essentially a ZIP archive containing various XML files that hold the document's content, styles, and other elements. 
`.DOC` files, on the other hand, are stored in a binary format, offering less structured storage compared to the XML-based DOCX format. 


> - OOXML (Office Open XML) is a file format used for various document types like spreadsheets, presentations, and word processing documents. It's an XML-based format, meaning it uses structured text (XML) to represent the document's data.
> - OOXML document files (`.docx, .xlsm`, etc.) supported by Microsoft Office are compressed zip archives.
> - Binary Microsoft Office document files (`.doc, .xls`, etc.) use the OLE2 (a.k.a. Structured Storage) format.
{: .prompt-information }


To understand the structure better, I decided to create one as a demo from scratch that we'll use to learn. In this case I use the normal Word application. (*Btw I'll try this with google sheets or calibre and compare the structures*). Anyway I wrote some dummy text and saved the file as `Lab.docx`.

![image](https://gist.github.com/user-attachments/assets/e4b21639-f7e3-4a7b-91c7-4ca7cd209e79)

Now, since we said a `docx` is an achieve file, it can be unzipped using simple tools like `unzip` or `7zip` and you're ready o do some analysis as shown. 

![image](https://gist.github.com/user-attachments/assets/9b74275b-ecd6-47bc-b478-1dcd7e022797)
![image](https://gist.github.com/user-attachments/assets/bb1d48db-836a-4670-923c-21b8c146c03d)


> Remember to deal with suspicious files in a sandbox environment.
{: .prompt-warning }


For folks who love using Linux or web applications for analysis, I'll also be sharing some tools and ticks to use.

## Tools

[DidierStevens](https://github.com/DidierStevens/DidierStevensSuite) has a very good suite of helpful scripts to use for analysis. In this blog, we'll mostly be using the following tools:

- [zipdump.py - (ZIP dump utility by Didier Stevens)](https://github.com/DidierStevens/DidierStevensSuite/blob/master/zipdump.py)
- [numbers-to-string.py - (Program to convert numbers into a string by Didier Stevens)](https://github.com/DidierStevens/DidierStevensSuite/blob/master/numbers-to-string.py)
- [xmldump.py - (This is essentially a wrapper for xml.etree.ElementTree by Didier Stevens)](https://github.com/DidierStevens/DidierStevensSuite/blob/master/xmldump.py)
- [re-search.py - (Program to use Python's re.findall on files by Didier Stevens)](https://github.com/DidierStevens/DidierStevensSuite/blob/master/re-search.py)

My go to online analyzer for quick analysis is [IRIS-H Digital Forensics](https://iris-h.services/#) (*Definitely check it out*)



## Basic Analysis

Examining a documents EXIF data is critical for a researcher  as it can reveal metadata like author, creation date, and application version for various purposes. These include: 
- Linking the document to a campaign.
- Spot inconsisencies in document timestamps.
- Discover potentially embedded data.

In the structure of a `.docx` file, this metadata info is usually stored in two files called `docProps/core.xml` and `docProps/app.xml`

To check the details, simply run the `exiftool` command alongside the file in question.

```bash
➜  exiftool Lab.docx
ExifTool Version Number         : 13.25
File Name                       : Lab.docx
Directory                       : .
File Size                       : 15 kB
File Modification Date/Time     : 2025:06:05 12:44:12+00:00
File Access Date/Time           : 2025:06:05 12:44:21+00:00
File Inode Change Date/Time     : 2025:06:05 12:44:12+00:00
File Permissions                : -rw-r--r--
File Type                       : DOCX
File Type Extension             : docx
MIME Type                       : application/vnd.openxmlformats-officedocument.wordprocessingml.document
Zip Required Version            : 20
Zip Bit Flag                    : 0x0006
Zip Compression                 : Deflated
Zip Modify Date                 : 1980:01:01 00:00:00
Zip CRC                         : 0x576f9132
Zip Compressed Size             : 358
Zip Uncompressed Size           : 1445
Zip File Name                   : [Content_Types].xml
Title                           :
Subject                         :
Creator                         : Test Author
Keywords                        :
Description                     :
Last Modified By                : Test Author
Revision Number                 : 2
Create Date                     : 2025:06:05 12:36:00Z
Modify Date                     : 2025:06:05 12:41:00Z
Template                        : Normal.dotm
Total Edit Time                 : 5 minutes
Pages                           : 1
Words                           : 23
Characters                      : 134
Application                     : Microsoft Office Word
Doc Security                    : None
Lines                           : 1
Paragraphs                      : 1
Scale Crop                      : No
Company                         :
Links Up To Date                : No
Characters With Spaces          : 156
Shared Doc                      : No
Hyperlinks Changed              : No
App Version                     : 16.0000
```
{: .nolineno }


As a researcher, details such as: *Creator* , *Create Date*, *Application*, *Modify Date*, *Pages*, *Words*, *Characters*  would matter to me - but I'll explain this more later in the blog.

## Docx Structure

Next, we can use a tool like `zipdump` to analyze a ZIP file contents as shown:

```bash
➜  python3 zipdump.py Lab.docx

Index Filename                     Encrypted Timestamp
    1 [Content_Types].xml                  0 1980-01-01 00:00:00
    2 _rels/.rels                          0 1980-01-01 00:00:00
    3 word/document.xml                    0 1980-01-01 00:00:00
    4 word/_rels/document.xml.rels         0 1980-01-01 00:00:00
    5 word/theme/theme1.xml                0 1980-01-01 00:00:00
    6 word/settings.xml                    0 1980-01-01 00:00:00
    7 word/numbering.xml                   0 1980-01-01 00:00:00
    8 word/styles.xml                      0 1980-01-01 00:00:00
    9 word/webSettings.xml                 0 1980-01-01 00:00:00
   10 word/fontTable.xml                   0 1980-01-01 00:00:00
   11 docProps/core.xml                    0 1980-01-01 00:00:00
   12 docProps/app.xml                     0 1980-01-01 00:00:00

```
{: .nolineno }


> Note that each Filename has a different Index number
{: .prompt-note }


I'll leave a small cheat sheet here that you can use for further analysis across the blog post

```bash
# Examine contents of OOXML file
python3 zipdump.py Lab.docx
or
python3 zipdump.py -i Lab.docx

# Extract file with specific index `3` from a file to STDOUT.
python3 zipdump.py Lab.docx -s 3 -d 

# Extract all files
python3 zipdump.py Lab.docx -D

# Print additional information
python3 zipdump.py Lab.docx -e
```
{: .nolineno }


### Simply explained:

| File                            | Purpose                                                                                                                    | Malware/Research Relevance                                                                                                                                               |
| ------------------------------- | -------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `[Content_Types].xml`           | Defines MIME types for all parts in the .docx archive.                                                                     | Can reveal unexpected file types (e.g., .vbs, .exe, .xml) indicating embedded malicious content.                                                                         |
| `_rels/.rels`                   | Links top-level components (e.g., document, metadata). Basically defines relationships to document.xml, core.xml, app.xml. | Malicious relationships may point to external resources (e.g., URLs for C2 servers) , remote OLE objects or scripts.                                                     |
| `word/document.xml`             | Main document content (text, paragraphs, macros, tables,  embedded objects).                                               | Common target for:  <br>- Macro-based malware (VBA, OLE).  <br>- Exploits (e.g., CVE-2017-0199 for remote templates). <br>- Obfuscated scripts (hidden text, XML bombs). |
| `word/_rels/document.xml.rels	` | Links external resources (images, hyperlinks, embedded objects).                                                           | Used to:  <br>- Load malicious payloads from remote URLs.  <br>- Reference embedded exploits (e.g., OLE objects).                                                        |
| `word/theme/theme1.xml`         | Defines visual styling (colors, fonts).                                                                                    | Rarely abused, but could conceal suspicious objects in obfuscated themes                                                                                                 |
| `word/settings.xml`             | Document settings (macros, protections, external links, zoom, spell-check).                                                | Critical for:  <br>- Enabling macros (attack vector).  <br>- Disabling security warnings.  <br>- Linking to malicious templates (`attachedTemplate`).                    |
| `word/numbering.xml`            | Defines list formatting (bullets, numbering).                                                                              | Low risk attack surface                                                                                                                                                  |
| `word/styles.xml`               | Styles (fonts, spacing, hidden text).                                                                                      | Can be used to:  <br>- Hide malicious content (e.g., white text).  <br>- Obfuscate script fragments in style names.                                                      |
| `word/webSettings.xml`          | Configures web view or HTML conversion settings.                                                                           | Rarely malicious, but may contain odd redirects or URLs.                                                                                                                 |
| `word/fontTable.xml`            | Lists fonts used in the document.                                                                                          | Could reference malicious font files (e.g., CVE-2015-3052 font parsing vulns).                                                                                           |
| `docProps/core.xml`             | Stores core metadata (e.g., author, creation date).                                                                        | Useful for:<br>- Attribution (threat actor fingerprints).<br>- Detecting tampering (e.g., fake timestamps).                                                              |
| `docProps/app.xml`              | Stores app-specific metadata (e.g., word count, Word version, page count).                                                 | May reveal anomalies (e.g., mismatched word counts due to hidden content or weaponized toolkits like CactusTorch).                                                       |

### Visual Overview:


- `[Content_Types].xml` - *Defines the MIME types (content types) of all the parts within the package. It tells the software like Word what kind of data each file contains (e.g., XML, images, etc.).*

![image](https://gist.github.com/user-attachments/assets/62d1c305-b24c-40cb-a101-4f97ca33855e)

- `_rels/.rels` - *Contains the root relationships of the document. It points to the key components of the document, such as the main document (`word/document.xml`) and metadata files (`docProps/core.xml` and `docProps/app.xml`).*

![image](https://gist.github.com/user-attachments/assets/0543780e-6f31-4baa-bb98-dafe0531f4fd)

- `word/document.xml` - *The main file containing the actual content of the document (text, paragraphs, tables, etc.), stored in a structured XML format. For example the dummy text I had in the document earlier*

![image](https://gist.github.com/user-attachments/assets/1731ac60-a3ce-4e80-b20f-113ed5da16ee)

- `word/_rels/document.xml.rels` - *Contains relationships for resources referenced in `document.xml`, such as hyperlinks, images, styles, or external files.*

![image](https://gist.github.com/user-attachments/assets/66bd9f0b-4987-40e3-8f4f-f8ee29ac43c5)

- `word/theme/theme1.xml` - *Defines the color scheme, fonts, and other visual theme elements used in the document.*

![image](https://gist.github.com/user-attachments/assets/a38b3da8-c910-4ac5-941d-c97649ded03a)

- `word/settings.xml` - *Stores document-level settings, such as proofing options, zoom level, compatibility settings, and other Word-specific configurations.*

![image](https://gist.github.com/user-attachments/assets/c071870e-1f2b-478e-a3ba-47d9a3e45465)
![image](https://gist.github.com/user-attachments/assets/4050ddc5-b601-42e5-9319-b43649b6cb4a)

- `word/numbering.xml` - *Defines the numbering (bullets and numbering) styles used in lists throughout the document.*

![image](https://gist.github.com/user-attachments/assets/3726d5ba-372e-4199-8192-bf0e819a9a0e)

`word/styles.xml`

![image](https://gist.github.com/user-attachments/assets/d1ca4965-2d83-470a-b055-6033a4f677b6)

- `word/webSettings.xml` - *Stores settings specific to how the document should behave when opened in a web browser or saved as a webpage.*

![image](https://gist.github.com/user-attachments/assets/cbf1fa3c-9e85-4774-9dc6-1973d421ba24)


`word/fontTable.xml`

![image](https://gist.github.com/user-attachments/assets/fe77e924-da85-476f-a827-cc7abc9bb174)

- `word/fontTable.xml` - *Lists all the fonts used in the document, including fallback fonts if the primary font is not available.*

![image](https://gist.github.com/user-attachments/assets/62098799-81d1-4a5e-b89d-c90fa1c611c4)

- `docProps/core.xml` - *Contains core document properties (metadata) such as title, author, creation/modification dates, and keywords.*

![image](https://gist.github.com/user-attachments/assets/31b1b71b-4007-4f19-a049-bdf185154d89)

- `docProps/app.xml` - *Contains application-specific metadata, such as word count, page count, and other statistics.*

![image](https://gist.github.com/user-attachments/assets/0b1498a7-7539-4352-bbad-4f2b111e3fa7)


## Analysis Samples

### Hashes

```bash
➜   md5sum *
45e7d6562bfddb816d45649dd667abde  Employee_W2_Form.docx
d5742309ba8146be9eab4396fde77e4e  Employees_Contact_Audit_Oct_2021.docx
41dacae2a33ee717abcc8011b705f2cb  Work_From_Home_Survey.doc
55998cb43459159a5ed4511f00ff3fc8  income_tax_and_benefit_return_2021.docx
➜   sha256sum *
679bbe0c50754853978a3a583505ebb99bce720cf26a6aaf8be06cd879701ff1  Employee_W2_Form.docx
ed2b9e22aef3e545814519151528b2d11a5e73d1b2119c067e672b653ab6855a  Employees_Contact_Audit_Oct_2021.docx
84674acffba5101c8ac518019a9afe2a78a675ef3525a44dceddeed8a0092c69  Work_From_Home_Survey.doc
d0e1f97dbe2d0af9342e64d460527b088d85f96d38b1d1d4aa610c0987dca745  income_tax_and_benefit_return_2021.docx
➜   sha1sum *
00087e46ec0ef6225de59868fd016bd9dd77fa3c  Employee_W2_Form.docx
8aaa79ee4a81d02e1023a03aee62a47162a9ff04  Employees_Contact_Audit_Oct_2021.docx
4b35d14a2eab2b3a7e0b40b71955cdd36e06b4b9  Work_From_Home_Survey.doc
9bec2182cc5b41fe8783bb7ab6e577bac5c19f04  income_tax_and_benefit_return_2021.docx
root@ip-172-31-6-252:~/Desktop/ChallengeFiles# 
```
{: .nolineno }



### To be Continued ........